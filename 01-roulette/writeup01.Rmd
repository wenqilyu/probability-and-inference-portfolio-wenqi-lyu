---
title: "assigh01-roulette"
author: " Wenqi Lyu"
date: "`r format(Sys.time(), '%B %d, %Y')`"
output: 
  html_document: 
    code_folding: hide
    toc: yes
    number_sections: true
    toc_depth: 3
    toc_float: true
---

incomplete. Please follow assignment instructions:

You should explain how you used computer simulation to calculate the
average earnings of a gambler that uses this strategy. As part of
the explanation, provide a figure (or a series of figures) that show
how the gamblers earnings (or losses) evolve over a series of wagers
at the roulette wheel. (The x-axis will be the wager number (or play
number), the y-axis will be earnings.) The code below provides all
the functions you’ll need to calculate average earnings.

Show your audience how changing a parameter of the simulation (see
table below) does or does not have an impact on average earnings. A
figure would be helpful.

See the stopping rule below. Explain to your audience how you used
computer simulation to estimate the average number of plays before
stopping. The code below will need to be modified to calculate this
quantity.

Be sure to explain the limitations of the simulation; identify
simplifications or other sources of uncertainty.

```{r global options, include = FALSE}
knitr::opts_chunk$set(echo=TRUE, warning=FALSE, message=FALSE)
```

# Introduction
There are several strategies for playing roulette. (Strategies is in italics because the house always wins, in the long run.) Consider one such strategy:“Martingale” strategy.

## Background
Here is an image could help you understand"Martingale":

![Caption: Image of Martingale.](/Users/sevenlv/Projects/probability-and-inference-portfolio-wenqi-lyu/01-roulette/martingale-strategy.svg){#id .class width=50% height=50%}

# Methods
```{r}
library(magrittr)
#' A single play of the Martingale strategy
#'
#' Takes a state list, spins the roulette wheel, returns the state list with updated values (for example, budget, plays, etc)
#' @param state A list with the following entries: 
#'   B              number, the budget
#'   W              number, the budget threshold for successfully stoping
#'   L              number, the maximum number of plays 
#'   M              number, the casino wager limit
#'   plays          integer, the number of plays executed
#'   previous_wager number, the wager in the previous play (0 at first play)
#'   previous_win   TRUE/FALSE, indicator if the previous play was a win (TRUE at first play)
#' @return The updated state list
one_play <- function(state){
  
    # Wager
    proposed_wager <- ifelse(state$previous_win, 1, 2*state$previous_wager)
    wager <- min(proposed_wager, state$M, state$B)
    
    # Spin of the wheel
    red <- rbinom(1,1,18/38)
    
    # Update state
    state$plays <- state$plays + 1
    state$previous_wager <- wager
    if(red){
      # WIN
      state$B <- state$B + wager
      state$previous_win <- TRUE
    }else{
      # LOSE
      state$B <- state$B - wager
      state$previous_win <- FALSE
    }
  state
}


#' Stopping rule
#'
#' Takes the state list and determines if the gambler has to stop
#' @param state A list.  See one_play
#' @return TRUE/FALSE
stop_play <- function(state){
  if(state$B <= 0) return(TRUE)
  if(state$plays >= state$L) return(TRUE)
  if(state$B >= state$W) return(TRUE)
  FALSE
}


#' Play roulette to either bankruptcy, success, or play limits
#'
#' @param B number, the starting budget
#' @param W number, the budget threshold for successfully stoping
#' @param L number, the maximum number of plays 
#' @param M number, the casino wager limit
#' @return A vector of budget values calculated after each play.
one_series <- function(
    B = 200
  , W = 300
  , L = 1000
  , M = 100
){

  # initial state
  state <- list(
    B = B
  , W = W
  , L = L
  , M = M
  , plays = 0
  , previous_wager = 0
  , previous_win = TRUE
  )
  
  # vector to store budget over series of plays
  budget <- rep(NA, L)
  
  # For loop of plays
  for(i in 1:L){
    new_state <- state %>% one_play
    budget[i] <- new_state$B
    if(new_state %>% stop_play){
      return(budget[1:i])
    }
    state <- new_state
  }
  budget    
}

# helper function
get_last <- function(x) x[length(x)] 

for(i in c(1:3)){
  one_person_play <- one_series(B = 200, W = 300, L = 1000, M = 100)
  
  plot(x=c(1:length(one_person_play)), y=one_person_play, type="l", xlab = "Play Number", ylab = "Money in Pocket")
}
# Simulation
walk_out_money <- rep(NA, 5000)
for(j in seq_along(walk_out_money)){
  walk_out_money[j] <- one_series(B = 200, W = 300, L = 1000, M = 100) %>% get_last
}


```
* Explanation of plots: These plots show three different people plat roulette. 
1st people: the more he/she plays, the more money in his/her pocket.
2nd people: he/she could earn money from roulette before about 175 times he/she plays. Then, he/she lose money.
3rd people: he/she almost do not lose money and earn money from this game, but when he/she plays over 15 times, he/she lose money.
* Explanation of Tomas code: It shows that one person has $200 starting budget, when he/she earn $100, or they do not have any money, he/she will stop playing this game. maximum number of plays is 1000, and wager limit is 100. The probability of red is 18/38. 
The estimated probability of walking out with extra cash is `r mean(walk_out_money > 200)`. The estimated earnings would be on average `r mean(walk_out_money - 200)`. 
we see on average we walk out with more money more than 1/2 of the time but our earnings are still negative. I would say these parameters show the gambling game is not safe and I still hope you not to play.

The function one_play: one_play shows us how the game plays and how the variables change, for example,time of plays.Each time we play, the state$plays will plus 1, if we win the game, we will earn some money, if we lose the game, we will lose money.The probability of red(win) is 18/38.

The function one_series: one_series show us the result of one person play the game, and 'one_series(B=200, W=300, L=1000, M=100)' means the walk of money of this person.


## Simulation

```{r}


# Walk out money distribution
hist(walk_out_money, breaks = 100)

# Estimated probability of walking out with extra cash
#mean(walk_out_money > 200)

# Estimated earnings
#mean(walk_out_money - 200)
```

The Estimate probability of walking out with extra cash is `r mean(walk_out_money > 200)`. The Estimate earnings would be on average `mean(walk_out_money - 200)`. Our estimated earnings are negative and we walk out with more money less than 1/2 of the time on average. We might lose some money on this game, we could change another strategy which is more profitable.

## Changing the the maximum number of plays 

L = 1000 changed to L=10, I hope to see that more people walk out with more than $0
```{r}

# Simulation
walk_out_money <- rep(NA, 5000)
for(j in seq_along(walk_out_money)){
  walk_out_money[j] <- one_series(B = 200, W = 300, L = 10, M = 100) %>% get_last
}

# Walk out money distribution
hist(walk_out_money, breaks = 100)

# Estimated probability of walking out with extra cash
#mean(walk_out_money > 200)

# Estimated earnings
#mean(walk_out_money - 200)
```
The Estimate probability of walking out with extra cash is `r mean(walk_out_money > 200)`. The Estimate earnings would be on average `r mean(walk_out_money - 200)`. more people will walk out with extra money than the simulation mentioned before.


### optional plot
```{r}
library(magrittr)
max_num_plays = seq(10,1000, by=10)
avg.earn= NA

for(i in c(1:length(max_num_plays))){
  #Simulation
  walk_out_money <- rep(NA,5000)
  for (j in seq_along(walk_out_money)){
    walk_out_money[j] <- one_series(B = 200, W= 300, L = max_num_plays[i], M = 100) %>% get_last
  }
  #Estimated earnings
  avg.earn[i] = mean(walk_out_money - 200)
}

plot(x=max_num_plays, y=avg.earn, type="l")
```

* Explanation of plot: The line graph shows the decreasing trend. The more time we plays, the lower earning we could get.

# Stopping Rule

```{r}
# Simulation
num.plays <- rep(NA,5000)
for(j in seq_along(num.plays)){
  num.plays[j] <- one_series(B = 200, W =300, L = 1000, M = 100) %>% length()
}


#Walk out money distribution

hist(num.plays, breaks = 10)
#mean(num.plays)
```
the mean number of plays is `r mean(num.plays)` , because this is so close to L=10 we know almost everyone is stopping because they reach the max of plays.

# Conclusion
Playing roulette in the B = 200, W =300, L = 1000, M = 100 scenario is high risk to lose money. But when the L decreases, more people will walk out with extra money than the simulation mentioned before.
I do not think roulette is profitable in all situations. we could see the last but 2 graph, it shows the decreasing trend. the earning of game is lower than 0.

# Limitation
1.the conclusion might be biased if we do not simulate a large amount of people participant in the roulette.

2.The Martingale strategy appears to always end in positive earnings, regardless of how unlucky a string of spins may be. the best case scenario is that we have 10 number of plays, the average earning is estimated 0, in the other case, the walk out money always negative.
