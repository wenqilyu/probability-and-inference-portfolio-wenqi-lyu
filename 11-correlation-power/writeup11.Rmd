---
title: "writeup09"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


A common research objective is to demonstrate that two measurements are
highly correlated. One measurement, call it A, may reflect the severity
of disease but is difficult or costly to collect. Another measurement,
call it B, may be easier to collect and potentially related to
measurement A. If there is strong association between A and B, a cost
effective strategy for diagnosis may be to collect measurement B instead
of A.

In this deliverable, you will perform a power and sample size
calculation for a collaborator who is submitting a grant application to
fund a study to show that two measurements are highly correlated.
Reviewers of the grant want to fund studies that have a high likelihood
of success, which in this setting is conclusively demonstrating that the
correlation between A and B is greater than 0.8.

The researcher will collect both measurements on N individuals. The
analysis will proceed by calculating a one-sided confidence interval. If
the confidence interval is completely within the range from 0.8 to 1,
then the researcher will consider the study to be a success: A
conclusive demonstration that the correlation between A and B is greater
than 0.8.

**Power** is the probability that the study will end in success when the
true underlying correlation is, in fact, greater that 0.8. (Note the
connection to Type II error (β): **power** = 1 - β.) Your collaborator
needs you to estimate power for different combinations of sample size
and the true population correlation. Let the sample size be 25, 50, 75,
and 100. Let the population correlation range from 0.8 to 0.95.

The code below provides the power calculation for a single combination
of N and population correlation.

```{r}
set.seed(20394)
suppressPackageStartupMessages(require(mvtnorm))
#Sample size
N <- 50

# True population correlation
rho <- .95
null_correlation <- 0.8
R <- 5000

sigma <- array(c(1,rho,rho,1), c(2,2))
mu <- c(0,0)

detect <- rep(NA, R)
for(i in 1:R){
  data <- rmvnorm(N, mean = mu, sigma = sigma)
  results <- cor.test(x = data[,1], y = data[,2], alternative = "greater")
  detect[i] <- results$conf.int[1] > null_correlation
}
power <- mean(detect)
```

```{r}
power.corr = function(N,rho){
  null_correlation <- 0.8
  R <- 5000
  power = NA
  for (j in 1:length(rho)) {
    sigma <- array(c(1,rho[j],rho[j],1),c(2,2))
    mu <- c(0,0)
    detect <- rep(NA,R)
    for (i in 1:R) {
      data <- rmvnorm(N[j],mean = mu,sigma = sigma)
      results <- cor.test(x = data[,1],y = data[,2],alternative = "greater")
      detect[i] <- results$conf.int[1] > null_correlation
    }
    power[j] <- mean(detect)
  }
  return(power)
}
rho <-  seq(0.8,0.95,0.01)
N <- c(25,50,75,100)
results2 = outer(X = N, Y = rho, FUN = power.corr)
```

```{r}
matplot(t(results2),type = "l",xaxt="n")
axis(1,labels = rho, at=c(1:length(rho)))
```

